app = "wingthing"
primary_region = "ewr"

[build]

[deploy]
  strategy = "rolling"

[processes]
  login = "sh -c 'mkdir -p /data/.wingthing && HOME=/data exec ./wt serve --addr :8080'"
  # edge = "./wt serve --addr :8080"

[env]
  WT_BASE_URL = "https://wingthing.ai"

[http_service]
  internal_port = 8080
  force_https = true
  auto_stop_machines = false
  auto_start_machines = true
  min_machines_running = 1
  processes = ["login"]

  [[http_service.checks]]
    interval = "10s"
    timeout = "2s"
    grace_period = "5s"
    method = "GET"
    path = "/health"

# Volume only on login node (SQLite lives here).
# Node role auto-detected: /data mounted = login, otherwise = edge.
# Login address auto-derived from Fly internal DNS (login.process.<app>.internal).
[[mounts]]
  source = "wt_data"
  destination = "/data"
  processes = ["login"]

[[vm]]
  size = "shared-cpu-2x"
  memory = "512mb"
  processes = ["login"]

# Horizontal scaling â€” uncomment edge process above, then:
#   fly deploy
#   fly scale count login=1 edge=3
#   fly scale count edge=2 --region nrt,lhr
#
# One-time setup:
#   fly secrets set WT_JWT_KEY=$(wt keygen)
