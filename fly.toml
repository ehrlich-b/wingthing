app = "wingthing"
primary_region = "ewr"

[build]

[deploy]
  strategy = "bluegreen"

[processes]
  login = "sh -c 'mkdir -p /data/.wingthing && HOME=/data exec ./wt serve --addr :8080'"
  edge = "./wt serve --addr :8080"

[env]
  WT_BASE_URL = "https://wingthing.ai"

# Both process groups serve HTTP â€” Fly anycast routes to nearest healthy machine.
[http_service]
  internal_port = 8080
  force_https = true
  auto_stop_machines = false
  auto_start_machines = true
  min_machines_running = 1
  processes = ["login", "edge"]

# Volume only on login node (SQLite lives here).
# Node role auto-detected: /data mounted = login, otherwise = edge.
# Login address auto-derived from Fly internal DNS (login.process.<app>.internal).
[[mounts]]
  source = "wt_data"
  destination = "/data"
  processes = ["login"]

[[vm]]
  size = "shared-cpu-1x"
  memory = "512mb"
  processes = ["login", "edge"]

# Deploy:
#   fly deploy
#   fly scale count login=1 edge=3
#   fly scale count edge=2 --region nrt,lhr
#
# One-time setup:
#   fly secrets set WT_JWT_SECRET=<base64-secret>
