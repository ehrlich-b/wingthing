{{define "title"}}wt - your AI agents, reachable from anywhere{{end}}
{{define "head"}}
<style>
.hero{padding:40px 0 24px;text-align:center}
.hero h1{font-size:28px;font-weight:700;letter-spacing:-0.03em;margin-bottom:8px}
.hero .tagline{color:var(--text-dim);font-size:15px;line-height:1.5;max-width:480px;margin:0 auto 24px}
.prompt-flow{font-family:var(--mono);font-size:18px;margin-top:8px}
.prompt-line{display:flex;align-items:center;justify-content:center;gap:6px;padding:8px 0}
.prompt-dim{color:var(--text-dim)}
.prompt-key{color:var(--text);font-weight:700;background:var(--bg-card);padding:2px 8px;border-radius:3px}
.prompt-hidden{display:none}
.hero-video{margin:24px auto 0;max-width:800px;position:relative;cursor:pointer}
.hero-video video{width:100%;border-radius:8px;border:1px solid var(--accent);display:block;pointer-events:none}
.hero-fs{position:absolute;bottom:12px;right:12px;background:rgba(0,0,0,0.5);border:none;color:#fff;width:36px;height:36px;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.15s;padding:0}
.hero-fs svg{width:18px;height:18px}
.hero-video:hover .hero-fs{opacity:1}
@media(hover:none){.hero-fs{opacity:0.7}}
a.prompt-line{text-decoration:none}
a.prompt-line:hover .prompt-key{background:var(--action);color:#fff}
.tab-bar{display:flex;gap:0;justify-content:center;font-family:var(--mono);font-size:13px;border-bottom:1px solid var(--accent);margin-bottom:0}
.tab-bar button{background:none;border:none;color:var(--text-dim);font-family:var(--mono);font-size:13px;padding:10px 20px;cursor:pointer;border-bottom:2px solid transparent;transition:color 0.15s,border-color 0.15s}
.tab-bar button:hover{color:var(--text)}
.tab-bar button.active{color:var(--text);border-bottom-color:var(--action)}
.how{padding:40px 0 20px}
.how h2{font-size:18px;font-weight:700;text-align:center;margin-bottom:28px;letter-spacing:-0.02em}
.how-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:32px}
.how-card{background:var(--bg-card);border-radius:6px;padding:20px}
.how-card h3{font-size:15px;font-weight:600;margin-bottom:6px;color:var(--action);font-family:var(--mono)}
.how-card p{color:var(--text-dim);font-size:13px;line-height:1.5}
.how-card code{background:var(--bg);padding:2px 6px;border-radius:3px;font-size:12px;color:var(--text)}
.links{display:flex;gap:16px;align-items:center;justify-content:center;padding:20px 0}
.links a{font-size:13px;color:var(--text-dim);text-decoration:none;font-family:var(--mono)}
.links a:hover{color:var(--text)}
.sb{padding:40px 0 20px}
.sb-layout{display:grid;grid-template-columns:1fr 1fr;gap:24px}
.sb-controls{display:flex;flex-direction:column;gap:20px}
.sb-section{background:var(--bg-card);border-radius:6px;padding:16px}
.sb-section h3{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-dim);margin-bottom:10px}
.sb-pills{display:flex;flex-wrap:wrap;gap:6px}
.sb-pill{background:var(--bg);border:1px solid var(--accent);color:var(--text-dim);font-family:var(--mono);font-size:12px;padding:4px 12px;border-radius:14px;cursor:pointer;transition:all 0.15s}
.sb-pill:hover{border-color:var(--action);color:var(--text)}
.sb-pill.active{background:var(--action);border-color:var(--action);color:#fff}
.sb-radios{display:flex;flex-direction:column;gap:6px}
.sb-radio{display:flex;align-items:baseline;gap:8px;cursor:pointer;font-size:12px;font-family:var(--mono)}
.sb-radio input{accent-color:var(--action)}
.sb-radio .desc{color:var(--text-dim);font-size:11px;margin-left:4px}
.sb-list{display:flex;flex-direction:column;gap:6px}
.sb-list-row{display:flex;gap:6px;align-items:center}
.sb-list-row input[type="text"]{flex:1;background:var(--bg);border:1px solid var(--accent);color:var(--text);font-family:var(--mono);font-size:12px;padding:4px 8px;border-radius:3px;outline:none}
.sb-list-row input[type="text"]:focus{border-color:var(--action)}
.sb-toggle{background:var(--bg);border:1px solid var(--accent);color:var(--text-dim);font-family:var(--mono);font-size:10px;padding:2px 8px;border-radius:3px;cursor:pointer;min-width:28px;text-align:center}
.sb-toggle.rw{color:var(--action);border-color:var(--action)}
.sb-btn{background:none;border:1px solid var(--accent);color:var(--text-dim);font-family:var(--mono);font-size:11px;padding:2px 8px;border-radius:3px;cursor:pointer}
.sb-btn:hover{border-color:var(--action);color:var(--text)}
.sb-btn.remove{border-color:transparent;color:var(--text-dim);opacity:0.5;font-size:13px;padding:0 4px}
.sb-btn.remove:hover{opacity:1;color:var(--action)}
.sb-add{margin-top:6px}
.sb-env-toggle{display:flex;align-items:center;gap:8px;font-size:12px;font-family:var(--mono);margin-bottom:8px}
.sb-env-toggle input{accent-color:var(--action)}
.sb-hint{font-size:11px;color:var(--text-dim);font-family:var(--mono);display:block;margin-top:2px}
.sb-empty{font-size:11px;color:var(--text-dim);font-family:var(--mono);font-style:italic;padding:4px 0}
.sb-res-row{display:flex;gap:12px;flex-wrap:wrap}
.sb-res-row label{font-size:11px;font-family:var(--mono);color:var(--text-dim);display:flex;flex-direction:column;gap:3px}
.sb-res-row input{background:var(--bg);border:1px solid var(--accent);color:var(--text);font-family:var(--mono);font-size:12px;padding:4px 8px;border-radius:3px;width:100px;outline:none}
.sb-res-row input:focus{border-color:var(--action)}
.sb-preview{position:relative}
.sb-preview pre{background:var(--bg-card);border-radius:6px;padding:16px 20px;font-family:var(--mono);font-size:12px;line-height:1.7;overflow-x:auto;white-space:pre;min-height:200px;color:var(--text)}
.y-base{opacity:0.4;color:var(--text-dim)}
.y-agent{opacity:0.55;color:var(--text-dim)}
.y-user{opacity:1;color:var(--text)}
.sb-copy{position:absolute;top:8px;right:8px;background:var(--accent);border:none;color:var(--text-dim);font-family:var(--mono);font-size:11px;padding:4px 10px;border-radius:3px;cursor:pointer;min-width:130px;text-align:center}
.sb-copy:hover:not(:disabled){color:var(--text);background:var(--action)}
.sb-copy:disabled{opacity:0.35;cursor:default}
.sb-tip{font-family:var(--mono);font-size:11px;color:var(--text-dim);line-height:1.6;margin-top:12px;padding:0 4px}
@media(max-width:700px){
  .hero h1{font-size:22px}
  .how-grid{grid-template-columns:1fr}
  .sb-layout{grid-template-columns:1fr}
  .install{font-size:11px;padding:12px 14px}
  .example{font-size:11px;padding:12px 14px}
}
</style>
{{end}}
{{define "content"}}
<script>
(function(){
    var hv=document.getElementById('hero-vid');
    if(hv){document.addEventListener('fullscreenchange',function(){hv.controls=!!document.fullscreenElement});document.addEventListener('webkitfullscreenchange',function(){hv.controls=!!document.webkitFullscreenElement})}
    document.addEventListener('keydown',function(e){
        var t=document.activeElement&&document.activeElement.tagName;
        if(t==='INPUT'||t==='TEXTAREA'||t==='SELECT')return;
        if(e.key==='.'&&!e.ctrlKey&&!e.metaKey&&!e.altKey){
            e.preventDefault();
            if(document.getElementById('prompt-flow')){
                window.location.href='/login';
                return;
            }
            var h=window.location.hostname;
            window.location.href=(h==='wingthing.ai'||h==='www.wingthing.ai')?'https://app.wingthing.ai':'/app/';
        }
    });
})();
</script>
<div class="hero">
<h1>your AI agents, reachable from anywhere</h1>
<p class="tagline">Run Claude, Codex, Cursor, and Gemini in a sandbox on your machine. Access them from any device over an encrypted, passkey-protected relay that can't read your data.</p>
{{if .User}}<div class="prompt-flow">
<a href="https://app.wingthing.ai" class="prompt-line" id="prompt-app"><span class="prompt-dim">press</span> <span class="prompt-key">.</span> <span class="prompt-dim">to</span> <span class="prompt-key">open app</span></a>
</div>
{{else}}<div class="prompt-flow" id="prompt-flow">
<div class="prompt-line"><span class="prompt-dim">press</span> <span class="prompt-key">.</span> <span class="prompt-dim">to start</span></div>
</div>{{end}}
{{if .HeroVideo}}<div class="hero-video" onclick="(function(){var v=document.getElementById('hero-vid');if(v.requestFullscreen)v.requestFullscreen();else if(v.webkitRequestFullscreen)v.webkitRequestFullscreen()})()"><video id="hero-vid" src="/hero.mp4" autoplay muted loop playsinline onloadedmetadata="this.playbackRate=0.8"></video><button class="hero-fs"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/></svg></button></div>{{end}}
</div>
<div class="tab-bar">
<button class="active" onclick="switchTab('how')">how it works</button>
<button onclick="switchTab('sb')">sandbox builder</button>
</div>
<div id="tab-how" class="how">
<h2>how it works</h2>
<div class="how-grid">
<div class="how-card">
<h3>wing</h3>
<p>Daemon that runs on your machine. <code>wt login</code>, <code>wt start</code>, and it encrypts the connection to the relay so your eggs are reachable.</p>
</div>
<div class="how-card">
<h3>roost</h3>
<p>The relay. Wings connect outbound to it, so you don't need to open ports or have a static IP. Use ours or <a href="/docs#self-hosting">host your own</a>.</p>
</div>
<div class="how-card">
<h3>egg</h3>
<p>Wraps each agent in a sandbox with a PTY and internal domain-filtered proxy. Survives disconnects. Claude Code, Codex, Cursor, Gemini.</p>
</div>
</div>
<div class="how-grid">
<div class="how-card">
<h3>single binary</h3>
<p>curl install, SQLite, nothing else to install. MIT licensed. Runs on macOS and Linux, x64 and arm64.</p>
</div>
<div class="how-card">
<h3>sandbox-first</h3>
<p>Define what agents can reach in <code>egg.yaml</code>, then let them run unattended. Seatbelt on macOS, namespaces on Linux.</p>
</div>
<div class="how-card">
<h3>e2e encrypted</h3>
<p>X25519 key exchange, AES-GCM. The roost is a dumb pipe, it never sees your wing's private data.</p>
</div>
<div class="how-card">
<h3>self-hostable</h3>
<p><code>wt serve</code> runs the roost on your machine. No account needed, no dependency on us.</p>
</div>
<div class="how-card">
<h3>any agent</h3>
<p><code>wt egg claude</code>, <code>wt egg ollama</code>, <code>wt egg gemini</code>. Switch the agent, keep your sandbox config.</p>
</div>
<div class="how-card">
<h3>passkey auth</h3>
<p>WebAuthn passkeys. 1Password, iCloud Keychain, Touch ID, Windows Hello. The roost never sees your credential.</p>
</div>
</div>
</div>
<div id="tab-sb" class="sb" style="display:none">
<div class="sb-layout">
<div class="sb-controls">

<div class="sb-section">
<h3>agent</h3>
<div class="sb-pills" id="sb-agents"></div>
</div>

<div class="sb-section">
<h3>filesystem</h3>
<label class="sb-env-toggle"><input type="checkbox" id="sb-base-fs" checked onchange="sbRender()"> inherit defaults</label>
<div class="sb-empty" id="sb-fs-empty">add rules to override defaults</div>
<div class="sb-list" id="sb-fs"></div>
<button class="sb-btn sb-add" onclick="sbAddFS()">+ add rule</button>
</div>

<div class="sb-section">
<h3>network</h3>
<label class="sb-env-toggle"><input type="checkbox" id="sb-base-net" checked onchange="sbRender()"> inherit defaults</label>
<div class="sb-radios" id="sb-net-mode"></div>
<div class="sb-list" id="sb-net-domains" style="margin-top:8px"></div>
<button class="sb-btn sb-add" id="sb-net-add" onclick="sbAddDomain()" style="display:none">+ add domain</button>
</div>

<div class="sb-section">
<h3>environment</h3>
<label class="sb-env-toggle"><input type="checkbox" id="sb-base-env" checked onchange="sbRender()"> inherit defaults</label>
<label class="sb-env-toggle"><input type="checkbox" id="sb-env-all" onchange="sbRender()"> pass all ("*")</label>
<div class="sb-list" id="sb-env"></div>
<button class="sb-btn sb-add" onclick="sbAddEnv()">+ add var</button>
</div>

<div class="sb-section">
<h3>resources</h3>
<div class="sb-res-row">
<label>cpu <input type="text" id="sb-cpu" placeholder="e.g. 300s" oninput="sbRender()"></label>
<label>memory <input type="text" id="sb-mem" placeholder="e.g. 2GB" oninput="sbRender()"></label>
<label>max_fds <input type="text" id="sb-fds" placeholder="e.g. 256" oninput="sbRender()"></label>
</div>
</div>

</div>
<div class="sb-preview">
<button class="sb-copy" id="sb-copy-btn" onclick="sbCopy()" disabled>nothing to copy yet</button>
<pre id="sb-yaml"></pre>
<div class="sb-tip">save as egg.yaml in your project root — wt egg claude reads it automatically<br>eggs are standalone sandboxes — no wing, no relay, no account needed</div>
</div>
</div>
</div>
<div class="how" id="pricing">
<h2>pricing</h2>
<div style="display:flex;justify-content:center;align-items:center;gap:10px;margin-bottom:20px;font-family:var(--mono);font-size:13px">
<span style="color:var(--text-dim)">monthly</span>
<label style="position:relative;display:inline-block;width:40px;height:22px;cursor:pointer">
<input type="checkbox" id="yearly-toggle" checked onchange="toggleBilling()" style="opacity:0;width:0;height:0">
<span style="position:absolute;inset:0;background:var(--accent);border-radius:11px;transition:background 0.2s"></span>
<span style="position:absolute;top:3px;left:3px;width:16px;height:16px;background:#fff;border-radius:50%;transition:transform 0.2s" id="toggle-dot"></span>
</label>
<span>yearly <span style="color:var(--action);font-weight:600">save 20%</span></span>
</div>
<div class="how-grid">
<div class="how-card">
<h3>free</h3>
<p style="font-size:20px;font-weight:700;margin:8px 0">$0</p>
<p>1 GB/month relay bandwidth<br>5 concurrent relay sessions<br>Unlimited local eggs</p>
</div>
<div class="how-card" style="border:1px solid var(--action)">
<h3>pro</h3>
<p style="font-size:20px;font-weight:700;margin:8px 0" id="pro-price">$4<span style="font-size:13px;font-weight:400">/mo</span></p>
<p style="font-size:11px;color:var(--text-dim);margin-bottom:8px" id="pro-note">billed yearly ($48)</p>
<p>Unlimited relay bandwidth<br>Unlimited relay sessions<br>Priority support</p>
</div>
<div class="how-card">
<h3>team</h3>
<p style="font-size:20px;font-weight:700;margin:8px 0" id="team-price">$4<span style="font-size:13px;font-weight:400">/seat/mo</span></p>
<p style="font-size:11px;color:var(--text-dim);margin-bottom:8px" id="team-note">billed yearly ($48/seat)</p>
<p>Each seat includes Pro<br>Shared wings (org access)<br>Audit logging<br>Invite-by-email</p>
</div>
</div>
<p style="text-align:center;font-family:var(--mono);font-size:12px;color:var(--text-dim);margin-top:12px">Self-hosting is always free. MIT licensed. <code style="background:var(--bg-card);padding:2px 6px;border-radius:3px;font-size:11px">wt serve --local</code></p>
</div>
<div class="links">
<a href="/docs">docs</a>
<a href="https://github.com/ehrlich-b/wingthing">github</a>
</div>
<script>
function toggleBilling(){
  var y=document.getElementById('yearly-toggle').checked;
  var dot=document.getElementById('toggle-dot');
  dot.style.transform=y?'translateX(18px)':'';
  document.getElementById('pro-price').innerHTML=y
    ?'$4<span style="font-size:13px;font-weight:400">/mo</span>'
    :'$5<span style="font-size:13px;font-weight:400">/mo</span>';
  document.getElementById('pro-note').textContent=y?'billed yearly ($48)':'billed monthly';
  document.getElementById('team-price').innerHTML=y
    ?'$4<span style="font-size:13px;font-weight:400">/seat/mo</span>'
    :'$5<span style="font-size:13px;font-weight:400">/seat/mo</span>';
  document.getElementById('team-note').textContent=y?'billed yearly ($48/seat)':'billed monthly';
}
// Init toggle dot position (starts checked = yearly)
document.addEventListener('DOMContentLoaded',function(){
  var dot=document.getElementById('toggle-dot');
  if(dot)dot.style.transform='translateX(18px)';
});
</script>
<script>
(function(){
var agents=['claude','codex','cursor','ollama','gemini'];
var profiles={
  claude:{env:['ANTHROPIC_API_KEY'],writeDirs:['~/.cache/claude/'],writeRegex:['~/.claude*'],domains:['*.anthropic.com','sentry.io','statsigapi.net']},
  codex:{env:['OPENAI_API_KEY'],writeDirs:['~/.codex/'],writeRegex:[],domains:['api.openai.com','*.openai.com']},
  cursor:{env:['ANTHROPIC_API_KEY','OPENAI_API_KEY'],writeDirs:['~/.cursor/','~/Library/Caches/cursor-compile-cache/'],writeRegex:[],domains:['api.anthropic.com','api.openai.com','*.cursor.sh']},
  ollama:{env:[],writeDirs:['~/.ollama/'],writeRegex:[],domains:['localhost']},
  gemini:{env:['GEMINI_API_KEY','GOOGLE_API_KEY'],writeDirs:['~/.gemini/'],writeRegex:[],domains:['*.googleapis.com','generativelanguage.googleapis.com']}
};
var defaultFS=[
  {mode:'rw',path:'./'},
  {mode:'rw',path:'~/.cache/'},
  {mode:'rw',path:'~/Library/Caches/'},
  {mode:'rw',path:'~/go/pkg/mod/cache/'},
  {mode:'deny',path:'~/.ssh'},
  {mode:'deny',path:'~/.gnupg'},
  {mode:'deny',path:'~/.aws'},
  {mode:'deny',path:'~/.docker'},
  {mode:'deny',path:'~/.kube'},
  {mode:'deny',path:'~/.netrc'},
  {mode:'deny',path:'~/.bash_history'},
  {mode:'deny',path:'~/.zsh_history'},
  {mode:'deny-write',path:'./egg.yaml'}
];
var defaultEnv=['HOME','PATH','TERM','LANG','USER'];
var netModes=[
  {val:'default',label:'default (none)',desc:'no network access'},
  {val:'domains',label:'domains',desc:'specific domains only'},
  {val:'*',label:'*',desc:'unrestricted'}
];

var state={
  baseFS:true,baseNet:true,baseEnv:true,
  agent:'',
  fs:[],
  netMode:'default',
  netDomains:[],
  envAll:false,
  envAllow:[],
  cpu:'',mem:'',fds:''
};

// Tab switching
window.switchTab=function(tab){
  var btns=document.querySelectorAll('.tab-bar button');
  btns[0].className=tab==='how'?'active':'';
  btns[1].className=tab==='sb'?'active':'';
  document.getElementById('tab-how').style.display=tab==='how'?'':'none';
  document.getElementById('tab-sb').style.display=tab==='sb'?'':'none';
  if(tab==='sb')sbRender();
};

// Init agent pills (single-select radio behavior)
var pillsEl=document.getElementById('sb-agents');
var pillBtns={};
agents.forEach(function(a){
  var b=document.createElement('button');
  b.className='sb-pill';
  b.textContent=a;
  b.onclick=function(){
    if(state.agent===a){state.agent='';b.className='sb-pill';}
    else{
      if(state.agent&&pillBtns[state.agent])pillBtns[state.agent].className='sb-pill';
      state.agent=a;b.className='sb-pill active';
    }
    sbRender();
  };
  pillBtns[a]=b;
  pillsEl.appendChild(b);
});

// Init network mode radios
var netEl=document.getElementById('sb-net-mode');
netModes.forEach(function(m){
  var label=document.createElement('label');
  label.className='sb-radio';
  var inp=document.createElement('input');
  inp.type='radio';inp.name='sb-net';inp.value=m.val;
  if(m.val==='default')inp.checked=true;
  inp.onchange=function(){state.netMode=m.val;renderNetDomains();sbRender();};
  label.appendChild(inp);
  var span=document.createElement('span');
  span.textContent=m.label;
  label.appendChild(span);
  var desc=document.createElement('span');
  desc.className='desc';
  desc.textContent=m.desc;
  label.appendChild(desc);
  netEl.appendChild(label);
});

function renderList(el,arr,renderRow){
  el.innerHTML='';
  arr.forEach(function(_,i){renderRow(el,i);});
}

function cycleMode(mode){
  if(mode==='rw')return'ro';
  if(mode==='ro')return'deny';
  return'rw';
}

function renderFS(){
  var el=document.getElementById('sb-fs');
  document.getElementById('sb-fs-empty').style.display=state.fs.length?'none':'';
  renderList(el,state.fs,function(el,i){
    var row=document.createElement('div');
    row.className='sb-list-row';
    var inp=document.createElement('input');
    inp.type='text';inp.value=state.fs[i].path;
    inp.oninput=function(){state.fs[i].path=inp.value;sbRender();};
    var tog=document.createElement('button');
    tog.className='sb-toggle'+(state.fs[i].mode==='rw'?' rw':'');
    tog.textContent=state.fs[i].mode;
    tog.onclick=function(){state.fs[i].mode=cycleMode(state.fs[i].mode);renderFS();sbRender();};
    var rm=document.createElement('button');
    rm.className='sb-btn remove';rm.textContent='x';
    rm.onclick=function(){state.fs.splice(i,1);renderFS();sbRender();};
    row.appendChild(inp);row.appendChild(tog);row.appendChild(rm);
    el.appendChild(row);
  });
}

function renderNetDomains(){
  var show=state.netMode==='domains';
  document.getElementById('sb-net-domains').style.display=show?'':'none';
  document.getElementById('sb-net-add').style.display=show?'':'none';
  if(!show)return;
  renderList(document.getElementById('sb-net-domains'),state.netDomains,function(el,i){
    var row=document.createElement('div');
    row.className='sb-list-row';
    var inp=document.createElement('input');
    inp.type='text';inp.value=state.netDomains[i];inp.placeholder='e.g. api.anthropic.com';
    inp.oninput=function(){state.netDomains[i]=inp.value;sbRender();};
    var rm=document.createElement('button');
    rm.className='sb-btn remove';rm.textContent='x';
    rm.onclick=function(){state.netDomains.splice(i,1);renderNetDomains();sbRender();};
    row.appendChild(inp);row.appendChild(rm);
    el.appendChild(row);
  });
}

function renderEnv(){
  renderList(document.getElementById('sb-env'),state.envAllow,function(el,i){
    var row=document.createElement('div');
    row.className='sb-list-row';
    var inp=document.createElement('input');
    inp.type='text';inp.value=state.envAllow[i];
    inp.oninput=function(){state.envAllow[i]=inp.value;sbRender();};
    var rm=document.createElement('button');
    rm.className='sb-btn remove';rm.textContent='x';
    rm.onclick=function(){state.envAllow.splice(i,1);renderEnv();sbRender();};
    row.appendChild(inp);row.appendChild(rm);
    el.appendChild(row);
  });
}

window.sbAddFS=function(){state.fs.push({mode:'rw',path:''});renderFS();sbRender();};
window.sbAddDomain=function(){state.netDomains.push('');renderNetDomains();};
window.sbAddEnv=function(){state.envAllow.push('');renderEnv();sbRender();};

function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function rpad(s,n){while(s.length<n)s+=' ';return s;}

window.sbRender=function(){
  state.baseFS=document.getElementById('sb-base-fs').checked;
  state.baseNet=document.getElementById('sb-base-net').checked;
  state.baseEnv=document.getElementById('sb-base-env').checked;
  state.envAll=document.getElementById('sb-env-all').checked;
  state.cpu=document.getElementById('sb-cpu').value;
  state.mem=document.getElementById('sb-mem').value;
  state.fds=document.getElementById('sb-fds').value;

  // 1. Build explicit yaml (user's egg.yaml for copy)
  var explLines=[];
  if(!state.baseFS&&!state.baseNet&&!state.baseEnv){
    explLines.push('base: none');
  }else if(!state.baseFS||!state.baseNet||!state.baseEnv){
    explLines.push('base:');
    if(!state.baseFS)explLines.push('  fs: none');
    if(!state.baseNet)explLines.push('  network: none');
    if(!state.baseEnv)explLines.push('  env: none');
  }
  var userFS=state.fs.filter(function(r){return r.path;});
  if(userFS.length){
    explLines.push('fs:');
    userFS.forEach(function(r){explLines.push('  - "'+r.mode+':'+r.path+'"');});
  }
  if(state.netMode==='domains'){
    var ud=state.netDomains.filter(function(d){return d;});
    if(ud.length){explLines.push('network:');ud.forEach(function(d){explLines.push('  - "'+d+'"');});}
  }else if(state.netMode==='*'){
    explLines.push('network: "*"');
  }
  if(state.envAll){
    explLines.push('env: "*"');
  }else{
    var ue=state.envAllow.filter(function(e){return e;});
    if(ue.length){explLines.push('env:');ue.forEach(function(e){explLines.push('  - "'+e+'"');});}
  }
  if(state.cpu||state.mem||state.fds){
    explLines.push('resources:');
    if(state.cpu)explLines.push('  cpu: "'+state.cpu+'"');
    if(state.mem)explLines.push('  memory: "'+state.mem+'"');
    if(state.fds)explLines.push('  max_fds: '+state.fds);
  }
  window._sbExplicit=explLines.join('\n');
  var hasExplicit=explLines.length>0;

  // 2. Build rendered preview (merged config with color classes)
  var pv=[]; // {text,cls}
  var ap=state.agent&&profiles[state.agent]?profiles[state.agent]:null;

  // Header comments when nothing configured
  if(!hasExplicit&&!state.agent){
    pv.push({text:'# no egg.yaml needed \u2014 these are the defaults',cls:'y-base'});
    pv.push({text:'# add overrides below, then copy your egg.yaml',cls:'y-base'});
    pv.push({text:'',cls:'y-base'});
  }

  // Base line in preview
  if(!state.baseFS&&!state.baseNet&&!state.baseEnv){
    pv.push({text:'base: none',cls:'y-user'});
  }else if(!state.baseFS||!state.baseNet||!state.baseEnv){
    pv.push({text:'base:',cls:'y-user'});
    if(!state.baseFS)pv.push({text:'  fs: none',cls:'y-user'});
    if(!state.baseNet)pv.push({text:'  network: none',cls:'y-user'});
    if(!state.baseEnv)pv.push({text:'  env: none',cls:'y-user'});
  }

  // Collect user rw/ro paths for deny override
  var userAccess={};
  state.fs.forEach(function(r){
    if(r.path&&(r.mode==='rw'||r.mode==='ro'))userAccess[r.path]=true;
  });

  // --- FS section ---
  if(state.baseFS){
    pv.push({text:rpad('fs:',32)+'# [base]',cls:'y-base'});
    // Base rw entries first
    defaultFS.forEach(function(r){
      if(r.mode==='rw')pv.push({text:'  - "rw:'+r.path+'"',cls:'y-base'});
    });
    // Agent write dirs
    if(ap){
      ap.writeDirs.forEach(function(d){
        pv.push({text:rpad('  - "rw:'+d+'"',38)+'# ['+state.agent+']',cls:'y-agent'});
      });
      ap.writeRegex.forEach(function(d){
        pv.push({text:rpad('  - "rw:'+d+'"',38)+'# ['+state.agent+'] (regex)',cls:'y-agent'});
      });
    }
    // Base deny rules (skip overridden by user rw/ro)
    defaultFS.forEach(function(r){
      if(r.mode!=='deny'&&r.mode!=='deny-write')return;
      if(userAccess[r.path])return;
      pv.push({text:'  - "'+r.mode+':'+r.path+'"',cls:'y-base'});
    });
    // User FS rules
    userFS.forEach(function(r){
      pv.push({text:'  - "'+r.mode+':'+r.path+'"',cls:'y-user'});
    });
  }else{
    // base.fs: none — no defaults
    var showFS=ap||userFS.length;
    if(showFS){
      pv.push({text:'fs:',cls:userFS.length?'y-user':'y-agent'});
      if(ap){
        ap.writeDirs.forEach(function(d){
          pv.push({text:rpad('  - "rw:'+d+'"',38)+'# ['+state.agent+']',cls:'y-agent'});
        });
        ap.writeRegex.forEach(function(d){
          pv.push({text:rpad('  - "rw:'+d+'"',38)+'# ['+state.agent+'] (regex)',cls:'y-agent'});
        });
      }
      userFS.forEach(function(r){
        pv.push({text:'  - "'+r.mode+':'+r.path+'"',cls:'y-user'});
      });
    }
  }

  // --- Network section ---
  var agentNet=ap?ap.domains:[];
  if(state.netMode==='*'){
    pv.push({text:'network: "*"',cls:'y-user'});
  }else if(state.netMode==='domains'){
    var udoms=state.netDomains.filter(function(d){return d;});
    if(udoms.length||agentNet.length){
      pv.push({text:'network:',cls:udoms.length?'y-user':'y-agent'});
      agentNet.forEach(function(d){
        pv.push({text:rpad('  - "'+d+'"',38)+'# ['+state.agent+']',cls:'y-agent'});
      });
      udoms.forEach(function(d){
        pv.push({text:'  - "'+d+'"',cls:'y-user'});
      });
    }
  }else{
    // default mode
    if(agentNet.length){
      pv.push({text:rpad('network:',32)+'# ['+state.agent+']',cls:'y-agent'});
      agentNet.forEach(function(d){
        pv.push({text:rpad('  - "'+d+'"',38)+'# ['+state.agent+']',cls:'y-agent'});
      });
    }else if(state.baseNet){
      pv.push({text:rpad('network: none',32)+'# [base]',cls:'y-base'});
    }
  }

  // --- Env section ---
  var agentEnv=ap?ap.env:[];
  var userEnv=state.envAllow.filter(function(e){return e;});
  if(state.envAll){
    pv.push({text:'env: "*"',cls:'y-user'});
  }else if(agentEnv.length||userEnv.length){
    pv.push({text:'env:',cls:userEnv.length?'y-user':'y-agent'});
    agentEnv.forEach(function(e){
      pv.push({text:rpad('  - "'+e+'"',38)+'# ['+state.agent+']',cls:'y-agent'});
    });
    userEnv.forEach(function(e){
      pv.push({text:'  - "'+e+'"',cls:'y-user'});
    });
    if(state.baseEnv){
      pv.push({text:'  # '+defaultEnv.join(', '),cls:'y-base'});
    }
  }else if(state.baseEnv){
    pv.push({text:rpad('env: ['+defaultEnv.join(', ')+']',38)+'# [base]',cls:'y-base'});
  }

  // --- Resources section ---
  if(state.cpu||state.mem||state.fds){
    pv.push({text:'resources:',cls:'y-user'});
    if(state.cpu)pv.push({text:'  cpu: "'+state.cpu+'"',cls:'y-user'});
    if(state.mem)pv.push({text:'  memory: "'+state.mem+'"',cls:'y-user'});
    if(state.fds)pv.push({text:'  max_fds: '+state.fds,cls:'y-user'});
  }

  // 3. Render HTML
  var html=pv.map(function(line){
    return '<span class="'+line.cls+'">'+esc(line.text)+'</span>';
  }).join('\n');
  document.getElementById('sb-yaml').innerHTML=html;

  // 4. Update copy button
  var copyBtn=document.getElementById('sb-copy-btn');
  var anyBaseCut=!state.baseFS||!state.baseNet||!state.baseEnv;
  if(hasExplicit||anyBaseCut){
    copyBtn.disabled=false;
    copyBtn.textContent='copy your egg.yaml';
  }else{
    copyBtn.disabled=true;
    copyBtn.textContent='nothing to copy yet';
  }
};

window.sbCopy=function(){
  if(!window._sbExplicit)return;
  if(navigator.clipboard){
    navigator.clipboard.writeText(window._sbExplicit).then(function(){
      var btn=document.getElementById('sb-copy-btn');
      btn.textContent='copied! paste into ./egg.yaml';
      setTimeout(function(){btn.textContent='copy your egg.yaml';},2000);
    });
  }
};

// Initial render
renderFS();
renderNetDomains();
renderEnv();
sbRender();
})();
</script>
{{end}}
